import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split, learning_curve
from sklearn.metrics import classification_report, confusion_matrix, ConfusionMatrixDisplay
from nltk.corpus import stopwords
from nltk.stem import SnowballStemmer
import string
import re
import nltk
import joblib
import seaborn as sns

# Настройка стиля графиков
plt.style.use('default')
sns.set_palette('husl')

# Скачивание стоп-слов (при первом запуске)
try:
    nltk.data.find('corpora/stopwords')
except LookupError:
    nltk.download('stopwords')

# Инициализация
russian_stopwords = stopwords.words("russian")
stemmer = SnowballStemmer("russian")

def preprocess_text(text):
    """Предварительная обработка текста"""
    if not isinstance(text, str):
        return ""

    text = text.lower()
    text = re.sub('[%s]' % re.escape(string.punctuation), '', text)
    text = re.sub(r'\d+', '', text)
    text = re.sub(r'\s+', ' ', text).strip()

    tokens = []
    for token in text.split():
        if token not in russian_stopwords:
            token = stemmer.stem(token)
            tokens.append(token)

    return " ".join(tokens)

# Загрузка данных из файла
try:
    df = pd.read_csv('учим.csv', sep=';', encoding='utf-8', header=0)

    # Объединение текстовых столбцов
    text_columns = [col for col in df.columns if df[col].dtype == 'object']
    df['text'] = df[text_columns].apply(lambda x: ' '.join(x.dropna().astype(str)), axis=1)
    df['processed_text'] = df['text'].apply(preprocess_text)

    # Создание меток
    keywords = ['преподаватель', 'учитель', 'репетитор', 'педагог', 'профессор',
                'образован', 'универ', 'лекц', 'студент', 'урок', 'школ', 'вуз']
    df['label'] = df['text'].apply(lambda x: int(any(word in x.lower() for word in keywords)))

    # Разделение данных
    X_train, X_test, y_train, y_test = train_test_split(
        df['processed_text'],
        df['label'],
        test_size=0.2,
        random_state=42
    )


